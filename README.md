# AarhusAI GitOps template

To install AarhusAI with this gitops template, you need to have a Kubernetes cluster with Helm 3 installed
and [ceph](https://rook.io/docs/rook/v1.12/Getting-Started/quickstart/) filesystem installed.

__NOTE__: Maybe Deranged can give some more information about the Ceph installation.

This installation documentation must be followed and executed in the correct order as described below, because the
different services require other services to be ready before they can be installed. In particular, ArgoCD needs to be
installed before Argo resources and sealed secrets, before Prometheus and Grafana etc.

The application requires you to generate new api-keys etc. and use sealed secrets to store them before a given service
is installed, and some need the keys/secrets from one to communicate with another.

Also, because all configuration is stored in GitOps as code, you need to update end-point and urls to match your domain.

## Bootstrap

The first step is to create a new GitHub repository based on this template repository.

### ArgoCD

For continues development and using GitOps to handle updates and configuration
changes. [ArgoCD](https://argo-cd.readthedocs.io/en/stable/) needs to be bootstrapped into the cluster.

Configuration to change need in `applications/argo-cd/values.yaml`:

```yaml
global:
  domain: <NAME>
```

Then one needs to install ArgoCD using the following commands:

```shell
helm repo add argocd https://argoproj.github.io/argo-helm
helm repo update
cd applications/argo-cd
helm dependency build
kubectl create namespace argo-cd
helm template argo-cd . -n argo-cd | kubectl apply -f -
```

You can check that ArgoCD is running by opening the ingress url:

```shell
kubectl get ingress -A
```

You can log into the webbased user interface as admin and by getting the password with this command:

```shell
kubectl -n argo-cd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
```

As an optional configuration, later one, we can install Authentic as SSO provider for the internal services in the
cluster.

### Argo resources

Now we can install the Argo resources, that defines the applications and their configuration. But first we need to
change the repository url to our own repository.

Edit `applications/argo-cd-resources/templates/applications.yaml`:

```yaml
spec:
  source:
    repoURL: https://github.com/aarhusai/<YOU REOP>.git
```

One also needs to change the configuration `sourceRepos` in every
`applications/argo-cd-resources/templates/projects/*.yaml` file for each application to argo knows with repos to stay in
sync with.

Last step in Argo installation is to install the resources:

```shell
cd applications/argo-cd-resources/
helm template argo-cd-resources . -n argo-cd | kubectl apply -f -
```

This will install all the application from `applications/argo-cd-resources/values.yaml` that are set to
`automated: true` which is alle the applications that do not need configuration changes. All the other applications will
need to have their configuration updated and changed to automatically sync with the repository.


-----------------------------

-----------------------------

-----------------------------


## Observability

Secrets for Prometheus and Grafana are generated by sealed secrets.

# SSO

https://github.com/bitnami-labs/sealed-secrets?tab=readme-ov-file#kubeseal

Only for internal SSO.

```yaml
global:
  configs:
    cm:
      oidc.config: |
        name: AarhusAI SSO
        issuer: https://auth.kom1.deranged.dk/application/o/argocd-kom1/
        clientID: bJDCFviyQcUXVIr2uXqbos5l6ZjIjBZlY0j647T4
        clientSecret: $oidc-authentik-client-secret:oidc.authentik.clientSecret
        requestedScopes: [openid, profile, email, groups]
```

templates/sealed-oidc-authentik-client-secret.yaml
